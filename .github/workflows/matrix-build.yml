name: Matrix Build with Artifacts

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18, 20, 22]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: matrix-987e3c6 - Build step
        run: |
          echo "matrix-987e3c6: Building for ${{ matrix.os }} with Node.js ${{ matrix.node-version }}"

      - name: Create build artifact
        # Use bash shell so the same script works cross-platform (Git Bash on windows runners).
        # Use node to generate an ISO timestamp so it works on all platforms.
        shell: bash
        run: |
          echo "Build Output for ${{ matrix.os }} - Node.js ${{ matrix.node-version }}" > build-output.txt
          echo "Build ID: 987e3c6" >> build-output.txt
          echo "Platform: ${{ matrix.os }}" >> build-output.txt
          echo "Node Version: ${{ matrix.node-version }}" >> build-output.txt
          # Use node (already installed by setup-node) to emit a consistent ISO timestamp across OSes
          echo "Timestamp: $(node -e 'console.log(new Date().toISOString())')" >> build-output.txt
          echo "Commit: ${{ github.sha }}" >> build-output.txt

          # Create additional test files (ensure directories are created cross-platform)
          mkdir -p dist
          echo "Compiled binary for ${{ matrix.os }}" > dist/app-${{ matrix.os }}-v${{ matrix.node-version }}.bin
          echo "{ \"node\": \"${{ matrix.node-version }}\", \"os\": \"${{ matrix.os }}\" }" > config-v${{ matrix.node-version }}.json

          # Show created files for logs and validation
          echo "Created files:"
          ls -la || true
          echo "--- build-output.txt content ---"
          cat build-output.txt || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          # Artifact name uses the required prefix
          name: build-987e3c6-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            build-output.txt
            dist/
            config-*.json
          retention-days: 7

      - name: Verify files exist
        shell: bash
        run: |
          echo "Checking if artifact files exist..."
          ls -la || true
          [ -f "build-output.txt" ] && echo "✓ build-output.txt exists" || echo "✗ build-output.txt missing"
          [ -d "dist" ] && echo "✓ dist directory exists" || echo "✗ dist directory missing"
